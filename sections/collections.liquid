<!-- Collections section content (Shopify section fragment) -->

		<main class="px-6 lg:px-16 py-16 space-y-12 max-w-6xl mx-auto">
			<!-- Hero / Banner -->
			<section class="reveal reveal-bottom bg-gradient-to-br from-purple-700/20 via-blue-500/10 to-transparent border border-white/10 rounded-3xl p-8 lg:p-12 overflow-hidden relative">
				<div class="relative z-10 space-y-4">
					<p class="text-xs uppercase tracking-[0.3em] text-white/50">Curated collections</p>
					<h1 class="text-4xl lg:text-5xl font-black uppercase italic leading-tight">Shop curated desk sets</h1>
					<p class="text-white/60 max-w-2xl">Pick from ready-made setups, mix lighting and decor, and add items straight to your cart. All items sync with the existing cart sidebar.</p>
					<div class="flex flex-wrap gap-3 pt-2">
						<div class="relative flex-1 min-w-[140px]">
							<button
								id="checkout-btn"
								class="w-full border border-white/10 text-white/20 px-4 py-3 rounded-xl text-xs font-black uppercase tracking-[0.2em] cursor-not-allowed transition-all duration-300"
								disabled
							>
								Ready-made Setups
							</button>

							<span
								class="absolute -top-2 -right-1 bg-purple-600 text-white text-[7px] font-bold uppercase tracking-widest px-1.5 py-0.5 rounded shadow-lg border border-purple-400/50 z-10 whitespace-nowrap"
							>
								Coming Soon
							</span>
						</div>

						<button
							id="cta-scroll"
							class="flex-1 min-w-[140px] border border-white/20 px-4 py-3 rounded-xl text-xs font-black uppercase tracking-[0.2em] text-white/80 hover:border-white hover:text-white transition-all duration-300"
						>
							View products
						</button>
					</div>
				</div>
				<div class="absolute -right-12 -bottom-12 w-64 h-64 bg-purple-500/20 blur-3xl rounded-full"></div>
			</section>

			<!-- Filters + Search -->
			<section class="reveal reveal-bottom space-y-4">
				<div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4">
					<div class="flex flex-wrap gap-3 items-center">
						<select id="sort-select" class="bg-white/5 border border-white/10 rounded-xl px-3 py-2 text-sm focus:outline-none focus:border-white/40">
							<option value="popular">Sort: Popular</option>
							<option value="price-asc">Price: Low → High</option>
							<option value="price-desc">Price: High → Low</option>
							<option value="new">Newest</option>
						</select>
						<div class="relative">
							<input
								id="search-input"
								type="text"
								placeholder="Search products"
								class="bg-white/5 border border-white/10 rounded-xl px-4 py-2 pr-10 text-sm focus:outline-none focus:border-white/40"
							/>
							<span class="absolute right-3 top-2.5 text-white/40 text-xs">⌕</span>
						</div>
					</div>
				</div>
				<p id="results-count" class="text-xs text-white/40 uppercase tracking-[0.2em]">0 items</p>
			</section>

			<!-- Product Grid -->
			<section id="products" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6"></section>
		</main>

		<!-- Footer (loaded from footer.html) -->
		<div id="footer-container"></div>

		<!-- Cart (loaded from cart.html) -->
		<script>
			/**
			 * Collections Page
			 *
			 * Логика загрузки товаров:
			 * 1. Пытается загрузить из Shopify API (если настроен)
			 * 2. Если Shopify недоступен → использует fallback из data.json
			 *
			 * Структура данных в data.json → collection_products[]
			 */

			let collectionItems = []
			// shopifyConfig уже объявлен в script.js, используем его

			const state = {
				sort: 'popular',
				search: '',
			}

			const dataUrl = "{{ 'data.json' | asset_url }}"
			const fallbackImage = "{{ 'min-01.jpg' | asset_url }}"

			const sortEl = document.getElementById('sort-select')
			const searchEl = document.getElementById('search-input')
			const productsEl = document.getElementById('products')
			const resultsCountEl = document.getElementById('results-count')
			const ctaScroll = document.getElementById('cta-scroll')
			const ctaOpenCart = document.getElementById('cta-open-cart')

			function formatPrice(value, currency = '€') {
				return `${currency}${Number(value).toFixed(2)}`
			}

			function filterItems() {
				return collectionItems
					.filter(item => {
						const q = state.search.trim().toLowerCase()
						const matchSearch = !q || item.title.toLowerCase().includes(q) || (item.description || '').toLowerCase().includes(q)
						return matchSearch
					})
					.sort((a, b) => {
						if (state.sort === 'price-asc') return a.price - b.price
						if (state.sort === 'price-desc') return b.price - a.price
						if (state.sort === 'new') return (b.isNew === true) - (a.isNew === true)
						// popular default: hits first
						return (b.isHit === true) - (a.isHit === true)
					})
			}

			function renderProducts() {
				const items = filterItems()
				resultsCountEl.textContent = `${items.length} items`

				if (!items.length) {
					productsEl.innerHTML = `<div class="col-span-full text-white/50 text-sm">No products found.</div>`
					return
				}

				const html = items
					.map(item => {
						const badge = item.badge || (item.isHit ? 'Hit' : item.isNew ? 'New' : '')
						const badgeHtml = badge ? `<span class="absolute top-3 right-3 text-[10px] uppercase tracking-[0.25em] bg-white text-black px-3 py-1 rounded-full">${badge}</span>` : ''
						const oldPriceHtml = item.oldPrice ? `<span class="text-white/30 line-through text-xs ml-2">${formatPrice(item.oldPrice, item.currency)}</span>` : ''
						const handle = item.shopify_handle || item.id
						return `
                        <article class="p-3 border border-white/5 bg-gradient-to-b from-white/[0.05] to-transparent backdrop-blur-2xl transition-all duration-500 hover:-translate-y-3 hover:border-purple-500/40 hover:shadow-[0_20px_50px_-10px_rgba(168,85,247,0.2)] rounded-2xl overflow-hidden">
                            <a href="product.html?handle=${handle}" class="block">
                                <div class="relative h-52 bg-white/5 overflow-hidden rounded-2xl">
                                    ${badgeHtml}
                                    <img src="${item.image}" alt="${item.title}" loading="lazy" class="w-full h-full object-cover transition-transform duration-500 hover:scale-105" />
                                </div>
                            </a>
                            <div class="p-5 space-y-3">
                                <div class="flex items-center gap-2 text-[10px] uppercase tracking-[0.3em] text-white/50">
                                    ${item.isHit ? '<span class="text-purple-400">hit</span>' : ''}
                                    ${item.isNew ? '<span class="text-green-400">new</span>' : ''}
                                </div>
                                <a href="product.html?handle=${handle}" class="block">
                                    <h3 class="text-lg font-black leading-tight hover:text-purple-400 transition-colors">${item.title}</h3>
                                </a>
                                <p class="text-white/60 text-sm leading-relaxed">${item.description}</p>
                                <div class="flex items-center justify-between pt-2">
                                    <div class="text-lg font-mono font-bold">${formatPrice(item.price, item.currency)}${oldPriceHtml}</div>
                                   <button
                                      class="add-btn relative w-10 h-10 flex items-center justify-center bg-white text-black rounded-lg hover:bg-purple-500 hover:text-white transition-all duration-300"
                                      data-handle="${handle}"
                                      aria-label="Add ${item.title} to cart"
                                      title="Add to cart"
                                    >
                                      <!-- Cart icon -->
                                      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-4 h-4">
                                        <circle cx="9" cy="21" r="1"></circle>
                                        <circle cx="20" cy="21" r="1"></circle>
                                        <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"></path>
                                      </svg>

                                      <!-- Plus badge (top-right) -->
                                      <span class="absolute -top-2 -right-2 w-5 h-5 bg-purple-600 text-white rounded-full flex items-center justify-center text-[10px] font-black border border-white/10">+</span>

                                      <span class="sr-only">Add to cart</span>
                                    </button>
                                </div>
                            </div>
                            <div class="flex items-center justify-between px-5 pb-4">
                                <div class="flex gap-0.5 text-sm">⭐ ${item.rating || 'N/A'}<span class="text-white/50 text-xs">(${item.reviewCount || 0})</span></div>
                            </div>
                        </article>
                    `
					})
					.join('')

				productsEl.innerHTML = html
			}

			/**
			 * Загрузка товаров из Shopify API
			 * В будущем здесь будет GraphQL запрос к Storefront API
			 */
			async function fetchShopifyProducts() {
				if (!shopifyConfig?.store_domain || shopifyConfig?.storefront_access_token === 'YOUR_STOREFRONT_ACCESS_TOKEN') {
					return null
				}

				// TODO: Реализовать Shopify Storefront API запрос
				// const query = `{ products(first: 20) { edges { node { ... } } } }`
				// const response = await fetch(`https://${shopifyConfig.store_domain}/api/2024-01/graphql.json`, {...})

				return null
			}

			/**
			 * Загрузка товаров коллекции
			 * Shopify → fallback из data.json
			 */
			async function loadCollectionProducts() {
				console.log('[Collections] Starting to load products...')

				try {
					// Загружаем data.json
					const response = await fetch(dataUrl)

					if (!response.ok) {
						throw new Error(`HTTP error! status: ${response.status}`)
					}

					const data = await response.json()
					console.log('[Collections] data.json loaded:', data)

					// Сохраняем конфиг Shopify
					if (data.shopify_config) {
						shopifyConfig = data.shopify_config
					}

					// Пробуем загрузить из Shopify
					const shopifyProducts = await fetchShopifyProducts()

					if (shopifyProducts && shopifyProducts.length > 0) {
						// Используем данные из Shopify
						collectionItems = shopifyProducts.map(p => ({
							id: p.id,
							shopify_handle: p.handle,
							title: p.title,
							description: p.description,
							price: parseFloat(p.variants?.[0]?.price || 0),
							oldPrice: p.compareAtPrice ? parseFloat(p.compareAtPrice) : null,
							currency: '€',
							image: p.images?.[0]?.url || fallbackImage,
							badge: null,
							isHit: false,
							isNew: false,
							rating: null,
							reviewCount: 0,
							available: p.availableForSale,
						}))
						console.log('[Collections] Loaded from Shopify:', collectionItems.length)
					} else if (data.collection_products && data.collection_products.length > 0) {
						// Fallback: используем локальные данные
						collectionItems = data.collection_products.map(p => {
							const fb = p.fallback
							return {
								id: fb.id || p.shopify_handle,
								shopify_handle: p.shopify_handle,
								title: fb.title,
								description: fb.description,
								price: parseFloat(fb.price) || 0,
								oldPrice: fb.old_price ? parseFloat(fb.old_price) : null,
								currency: fb.currency || '€',
								image: fb.image || fallbackImage,
								badge: fb.badge || null,
								isHit: fb.is_hit || false,
								isNew: fb.is_new || false,
								rating: fb.rating || null,
								reviewCount: fb.reviews_count || 0,
								available: fb.available !== false,
							}
						})
						console.log('[Collections] Loaded from fallback:', collectionItems.length, collectionItems)
					} else {
						console.warn('[Collections] No products found in data.json')
						collectionItems = []
					}

					renderProducts()
				} catch (error) {
					console.error('[Collections] Failed to load products:', error)
					productsEl.innerHTML = `<div class="col-span-full text-red-400 text-sm">Failed to load products. Please try again later.</div>`
				}
			}

			// Event wiring
			if (sortEl) {
				sortEl.addEventListener('change', () => {
					state.sort = sortEl.value
					renderProducts()
				})
			}

			if (searchEl) {
				let t
				searchEl.addEventListener('input', () => {
					clearTimeout(t)
					t = setTimeout(() => {
						state.search = searchEl.value
						renderProducts()
					}, 220)
				})
			}

			document.addEventListener('click', e => {
				const btn = e.target.closest('.add-btn')
				if (btn) {
					const handle = btn.dataset.handle
					const item = collectionItems.find(x => (x.shopify_handle || x.id) === handle)
					if (item && typeof Cart !== 'undefined') {
						Cart.addItem({
							id: item.shopify_handle || item.id,
							title: item.title,
							price: item.price,
							image: item.image,
						})
					}
				}
			})

			if (ctaScroll) {
				ctaScroll.addEventListener('click', () => {
					document.getElementById('products')?.scrollIntoView({ behavior: 'smooth' })
				})
			}

			if (ctaOpenCart) {
				ctaOpenCart.addEventListener('click', () => {
					if (typeof Cart !== 'undefined') Cart.open()
				})
			}

{% schema %}
{
  "name": "Collections",
  "settings": [],
  "blocks": [],
  "presets": [
	{
	  "name": "Collections",
	  "category": "Pages"
	}
  ]
}
{% endschema %}
